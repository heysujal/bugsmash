name: Autonomous Bug Fixer

on:
  workflow_dispatch:
    inputs:
      repo_url:
        description: "Repository URL (e.g., https://github.com/heysujal/sample-eslint)"
        required: true
        default: "https://github.com/heysujal/sample-eslint"

jobs:
  run-fixer:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      # 1. Checkout the workflow repository
      - name: Checkout workflow repository
        uses: actions/checkout@v4
        with:
          # Use a PAT with repo scope instead of default GITHUB_TOKEN
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true

      # 2. Setup Node.js
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # 3. Install GitHub CLI
      - name: Install GitHub CLI
        run: |
          type -p curl >/dev/null || (sudo apt update && sudo apt install curl -y)
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt update
          sudo apt install gh -y

      # 4. Install jq for JSON parsing
      - name: Install jq
        run: sudo apt-get install -y jq

      # 5. Install Cline globally
      - name: Install Cline
        run: |
          npm install -g cline
          cline --version || echo "Cline installed"

      # 6. Make script executable
      - name: Make script executable
        run: chmod +x ./.github/scripts/run-bugfixer.sh

      # 7. Execute the bug fixer script
      - name: Run Bug Fixer Script
        run: |
          ./.github/scripts/run-bugfixer.sh \
            "${{ github.event.inputs.repo_url }}" \
            "${{ secrets.GEMINI_API_KEY }}" \
            "gemini-1.5-flash"
        env:
          # Use PAT_TOKEN if available, otherwise GITHUB_TOKEN
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
          GH_TOKEN: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}