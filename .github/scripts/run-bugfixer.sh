#!/bin/bash
set -e

# --- Configuration ---
REPO_URL=$(echo "$1" | tr -d '[:space:]')
MY_AI_API_KEY=$(echo "$2" | tr -d '[:space:]')
MODEL_ID=$(echo "$3" | tr -d '[:space:]')

if [ -z "$REPO_URL" ] || [ -z "$MY_AI_API_KEY" ] || [ -z "$MODEL_ID" ]; then
    echo "Error: Required arguments are missing."
    exit 1
fi

TARGET_DIR="target_repo"
BRANCH_NAME="bugfix-$(date +%s)"
COMMIT_MESSAGE="feat(cline): autonomous fix for lint issues"

echo "Starting autonomous bug fixer on branch: $BRANCH_NAME"
echo "--------------------------------------------------------"

# 1. Clone the TARGET repository FIRST
echo "Cloning target repo: $REPO_URL into $TARGET_DIR"
git clone "$REPO_URL" "$TARGET_DIR"

# 2. Enter the target repository
cd "$TARGET_DIR"

# 3. Setup Git (AFTER entering the target repo)
git config user.email "bughunter-bot@github.com"
git config user.name "BugHunter Bot"

# 4. Create and switch to a new branch
git checkout -b "$BRANCH_NAME"

# 5. Install dependencies IN THE TARGET REPO
echo "Installing dependencies in target repo..."
npm install

# 6. AUTHENTICATE CLINE
echo "Authenticating Cline CLI..."
cline auth --provider openai-native --apikey "$MY_AI_API_KEY" --modelid "$MODEL_ID"

# 7. Run ESLint and capture output
echo "Running ESLint..."
LINT_FILE="lint.json"

# Run eslint directly (not via npm script to avoid issues)
npx eslint . --format json --output-file "$LINT_FILE" || true

echo "--- DEBUG: LINT.JSON CONTENT ---"
if [ -f "$LINT_FILE" ]; then
    cat "$LINT_FILE" | head -50
    ISSUES_COUNT=$(cat "$LINT_FILE" | jq 'map(.messages | length) | add // 0')
    echo "Total issues found: $ISSUES_COUNT"
else
    echo "Lint file not found. Creating empty array."
    echo "[]" > "$LINT_FILE"
fi

# 8. Run Cline to generate the patch
echo "Running Cline to generate patch..."
PATCH_FILE="patch.diff"
SUMMARY_FILE="cline_summary.txt"

# Create a prompt file for Cline
cat > cline_prompt.txt << 'EOF'
Review the attached lint.json file containing ESLint errors and warnings.
Generate fixes for all the issues found.
Create a git patch file that can be applied to fix these issues.
Follow best practices and maintain code style consistency.
EOF

# Run Cline with the prompt and lint file
cline "$(cat cline_prompt.txt)" \
  -y \
  -o \
  -f "$LINT_FILE" \
  --no-interactive \
  > "$SUMMARY_FILE" 2>&1 || true

echo "--- DEBUG: CLINE SUMMARY (STDOUT/STDERR) ---"
cat "$SUMMARY_FILE"

# 9. Check if Cline generated changes
echo "Checking for changes..."
if git diff --quiet && git diff --cached --quiet; then
    echo "No changes detected from Cline. Checking for patch file..."
    
    if [ -f "$PATCH_FILE" ] && [ -s "$PATCH_FILE" ]; then
        echo "Patch file found. Applying..."
        git apply "$PATCH_FILE" || {
            echo "Patch apply failed. Trying with --reject..."
            git apply --reject "$PATCH_FILE" || echo "Continuing despite patch errors..."
        }
    else
        echo "No patch generated by Cline. Checking if Cline made direct changes..."
        
        # Check again after potential patch application
        if git diff --quiet && git diff --cached --quiet; then
            echo "No changes to commit. Exiting successfully."
            exit 0
        fi
    fi
fi

# 10. Stage all changes
echo "Staging changes..."
git add -A

# 11. Check if there are staged changes
if git diff --cached --quiet; then
    echo "No changes to commit after staging. Exiting."
    exit 0
fi

# 12. Commit the changes
echo "Committing changes..."
git commit -m "$COMMIT_MESSAGE" -m "Auto-generated fixes for lint issues using Cline AI"

# 13. Push the branch
echo "Pushing branch $BRANCH_NAME to origin..."
git push origin "$BRANCH_NAME"

echo "âœ… Branch pushed successfully!"

# 14. Create Pull Request using GitHub CLI
echo "Creating Pull Request..."
gh pr create \
  --title "ðŸ¤– Auto-fix: Lint issues ($BRANCH_NAME)" \
  --body "This PR was automatically generated to fix ESLint issues.

## Summary
$(cat "$SUMMARY_FILE" | head -20)

## Changes
- Fixed lint errors and warnings
- Applied best practices
- Maintained code style consistency

**Branch:** $BRANCH_NAME
**Generated:** $(date)" \
  --base main \
  --head "$BRANCH_NAME" || {
    echo "Failed to create PR via gh CLI. You may need to create it manually:"
    echo "https://github.com/$(git remote get-url origin | sed 's/.*github.com[:/]\(.*\)\.git/\1/')/compare/$BRANCH_NAME"
}

echo "=========================================="
echo "âœ… AUTONOMOUS BUG FIXER COMPLETED!"
echo "=========================================="
echo "Branch: $BRANCH_NAME"
echo "Repository: $REPO_URL"